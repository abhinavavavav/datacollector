<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Info Collector</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 700px; }
    label, input, textarea { display: block; margin: 10px 0; width: 100%; }
  </style>
</head>
<body>
  <h2>User Info Collection (with Consent)</h2>

  <form id="userForm" action="https://formsubmit.co/abhinavavpavithranav@gmail.com" method="POST">
    <label>Name: <input type="text" name="name" required></label>
    <label>Email: <input type="email" name="email" required></label>
    <label>Message: <textarea name="message" required></textarea></label>

    <label>
      <input type="checkbox" id="consentCheckbox" required>
      I give consent to collect my device and browser information.
    </label>

    <input type="hidden" name="collectedInfo" id="collectedInfo">

    <!-- FormSubmit options -->
    <input type="hidden" name="_template" value="table">
    <input type="hidden" name="_captcha" value="false">
    <input type="hidden" name="_subject" value="New User Info Collected">
    <input type="hidden" name="_next" value="https://abhinavavavav.github.io/thanks.html">

    <button type="submit">Submit</button>
  </form>

  <script>
    const form = document.getElementById('userForm');

    form.addEventListener('submit', async function (e) {
      e.preventDefault();

      if (!document.getElementById('consentCheckbox').checked) {
        alert('Please give consent to proceed.');
        return;
      }

      const formData = new FormData(form);
      const name = formData.get('name');
      const email = formData.get('email');
      const message = formData.get('message');

      const collected = {
        "Name": name,
        "Email": email,
        "Message": message,
        "UserAgent": navigator.userAgent,
        "Language": navigator.language,
        "Platform": navigator.platform,
        "Vendor": navigator.vendor,
        "ScreenWidth": screen.width,
        "ScreenHeight": screen.height,
        "PixelRatio": window.devicePixelRatio,
        "TouchSupport": 'ontouchstart' in window || navigator.maxTouchPoints > 0,
        "Timezone": Intl.DateTimeFormat().resolvedOptions().timeZone,
        "LocalTime": new Date().toString(),
        "DeviceMemoryGB": navigator.deviceMemory || "Not available",
        "CPUThreads": navigator.hardwareConcurrency || "Not available"
      };

      if ('connection' in navigator) {
        const conn = navigator.connection;
        collected["ConnectionType"] = conn.type || "Unknown";
        collected["EffectiveConnectionType"] = conn.effectiveType || "Unknown";
        collected["DownlinkMbps"] = conn.downlink || "Unknown";
      }

      if ('getBattery' in navigator) {
        try {
          const battery = await navigator.getBattery();
          collected["BatteryLevel"] = (battery.level * 100) + "%";
          collected["IsCharging"] = battery.charging ? "Yes" : "No";
          collected["ChargingTimeSec"] = battery.chargingTime;
          collected["DischargingTimeSec"] = battery.dischargingTime;
        } catch (err) {
          collected["BatteryInfo"] = "Permission denied or not supported";
        }
      } else {
        collected["BatteryInfo"] = "Not supported";
      }

      // Get location
      if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            collected["Latitude"] = position.coords.latitude;
            collected["Longitude"] = position.coords.longitude;
            collected["LocationAccuracyMeters"] = position.coords.accuracy;
            fetchIPAndSubmit(collected);
          },
          () => {
            collected["Location"] = "Denied or unavailable";
            fetchIPAndSubmit(collected);
          }
        );
      } else {
        collected["Location"] = "Geolocation not supported";
        fetchIPAndSubmit(collected);
      }
    });

    function fetchIPAndSubmit(collected) {
      fetch("https://api.ipify.org?format=json")
        .then((res) => res.json())
        .then((data) => {
          collected["PublicIP"] = data.ip;
          finalizeAndSubmit(collected);
        })
        .catch(() => {
          collected["PublicIP"] = "Unavailable";
          finalizeAndSubmit(collected);
        });
    }

    function flatten(obj, prefix = '') {
      const flat = {};
      for (let key in obj) {
        const value = obj[key];
        const newKey = prefix ? `${prefix}_${key}` : key;
        if (typeof value === 'object' && value !== null) {
          Object.assign(flat, flatten(value, newKey));
        } else {
          flat[newKey] = value;
        }
      }
      return flat;
    }

    function finalizeAndSubmit(collected) {
      const flatCollected = flatten(collected);
      document.getElementById('collectedInfo').value = JSON.stringify(flatCollected);
      form.submit();
    }
  </script>
</body>
</html>
